<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Smart Complaint Box</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 20px; line-height: 1.6; }
    .top-links { margin-bottom: 20px; }
    h1 { margin-top: 0; }
    form { margin-bottom: 15px; }
    input[type=password], input[type=text] { padding: 8px; width: 100%; box-sizing: border-box; margin-top: 6px; }
    button { padding: 8px 14px; cursor: pointer; background: #007bff; border: none; border-radius: 4px; color: white; margin-top: 8px; }
    button:disabled { background: #999; cursor: not-allowed; }
    .alert { padding: 10px; margin: 10px 0; border-radius: 5px; display: none; }
    .alert.success { background-color: #d4edda; color: #155724; }
    .alert.error { background-color: #f8d7da; color: #721c24; }
    .hidden { display: none; }
    .disabled-input { background-color: #e9ecef; }
    .disabled-btn { cursor: not-allowed; opacity: 0.6; }
    .update-btn, .delete-btn { padding: 4px 8px; font-size: 12px; margin-right: 5px; }
    .table-container { overflow-x: auto; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
    th { background-color: #f2f2f2; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    a { text-decoration: none; color: #007bff; }
    a:hover { text-decoration: underline; }
    /* Badge styles */
    .mode-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .badge-readonly { background: #e9ecef; color: #495057; }
    .badge-modify { background: #d4edda; color: #155724; }
  </style>
</head>
<body>
  <div class="top-links">
    <a href="/">Submit a Complaint</a> | <a href="/track">Track a Complaint</a> | <a href="/admin">Admin Panel</a>
  </div>

  <!-- Step 1: Admin Key -->
  <div id="auth-section">
    <h1>Admin Access</h1>
    <div id="auth-message" class="alert"></div>
    <form id="auth-form">
      <label for="auth-key">Enter Admin Key:</label>
      <input type="password" id="auth-key" required>
      <button type="submit">Verify</button>
    </form>
  </div>

  <!-- Step 2: Modify Key -->
  <div id="modify-access-section" class="hidden">
    <div id="modify-message" class="alert"></div>
    <form id="modify-form">
      <label for="modify-key">Enter Modification Key:</label>
      <input type="password" id="modify-key" required>
      <button type="submit">Unlock Modify Access</button>
    </form>
  </div>

  <!-- Step 3: Admin Panel -->
  <div id="admin-panel-content" class="hidden">
    <h1>Admin Panel</h1>
    <span id="mode-badge" class="mode-badge badge-readonly hidden">ðŸ”’ Read-Only Mode</span>
    <p>All submitted complaints.</p>
    <div id="status-message" class="alert"></div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Complaint ID</th>
            <th>Submitted On</th>
            <th>User Input</th>
            <th>Status</th>
            <th>Assigned To</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for complaint in complaints %}
          <tr data-complaint-id="{{ complaint.complaint_id }}">
            <td><a href="/track?id={{ complaint.complaint_id }}">{{ complaint.complaint_id }}</a></td>
            <td>{{ complaint.created_at.strftime('%d-%m-%Y %H:%M') }}</td>
            <td>{{ complaint.user_input }}</td>
            <td>
              <select name="status" disabled class="disabled-input">
                <option value="Pending" {% if complaint.status == 'Pending' %}selected{% endif %}>Pending</option>
                <option value="In Progress" {% if complaint.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                <option value="Resolved" {% if complaint.status == 'Resolved' %}selected{% endif %}>Resolved</option>
              </select>
            </td>
            <td>
              <input type="text" name="assigned_to" value="{{ complaint.assigned_to }}" disabled class="disabled-input">
            </td>
            <td>
              <button class="update-btn disabled-btn" disabled onclick="updateComplaint(this)">Update</button>
              <button class="delete-btn disabled-btn" disabled onclick="deleteComplaint(this)">Delete</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let modifyKey = null;

    function showAlert(el, message, type) {
      el.textContent = message;
      el.className = `alert ${type}`;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    function setModeBadge(mode) {
      const badge = document.getElementById('mode-badge');
      badge.classList.remove('hidden', 'badge-readonly', 'badge-modify');
      if (mode === 'readonly') {
        badge.textContent = "ðŸ”’ Read-Only Mode";
        badge.classList.add('badge-readonly');
      } else if (mode === 'modify') {
        badge.textContent = "âœï¸ Modify Mode";
        badge.classList.add('badge-modify');
      }
    }

    // Step 1: Admin Key
    document.getElementById('auth-form').addEventListener('submit', async function(event) {
      event.preventDefault();
      const key = document.getElementById('auth-key').value.trim();
      const message = document.getElementById('auth-message');
      showAlert(message, "Verifying...", "success");

      try {
        const response = await fetch('/verify_key', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key })
        });
        const data = await response.json();

        if (response.ok && data.success) {
          document.getElementById('auth-section').classList.add('hidden');
          document.getElementById('admin-panel-content').classList.remove('hidden');

          if (data.permission_level === 'read-write') {
            modifyKey = key;
            enableModification();
            setModeBadge('modify');
          } else {
            document.getElementById('modify-access-section').classList.remove('hidden');
            setModeBadge('readonly');
          }
          showAlert(message, `Access granted: ${data.permission_level}`, "success");
        } else {
          showAlert(message, `Error: ${data.error}`, "error");
        }
      } catch (error) {
        showAlert(message, `An error occurred: ${error.message}`, "error");
      }
    });

    // Step 2: Modify Key
    document.getElementById('modify-form').addEventListener('submit', async function(event) {
      event.preventDefault();
      const key = document.getElementById('modify-key').value.trim();
      const message = document.getElementById('modify-message');
      showAlert(message, "Verifying modification key...", "success");

      try {
        const response = await fetch('/verify_key', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key })
        });
        const data = await response.json();

        if (response.ok && data.success && data.permission_level === 'read-write') {
          modifyKey = key;
          enableModification();
          document.getElementById('modify-access-section').classList.add('hidden');
          setModeBadge('modify');
          showAlert(message, "Modification access granted!", "success");
        } else {
          showAlert(message, "Invalid modification key.", "error");
        }
      } catch (error) {
        showAlert(message, `An error occurred: ${error.message}`, "error");
      }
    });

    function enableModification() {
      document.querySelectorAll('.disabled-input').forEach(el => {
        el.removeAttribute('disabled');
        el.classList.remove('disabled-input');
      });
      document.querySelectorAll('.disabled-btn').forEach(el => {
        el.removeAttribute('disabled');
        el.classList.remove('disabled-btn');
      });
    }

    // --- Update Complaint ---
    async function updateComplaint(button) {
      const row = button.closest("tr");
      const complaintId = row.dataset.complaintId;
      const status = row.querySelector('select[name="status"]').value;
      const assignedTo = row.querySelector('input[name="assigned_to"]').value;

      const payload = {
        complaint_id: complaintId,
        modify_key: modifyKey,
        status: status,
        assigned_to: assignedTo
      };

      const statusMessage = document.getElementById("status-message");
      showAlert(statusMessage, "Updating complaint...", "success");

      try {
        const response = await fetch("/update_complaint", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await response.json();

        if (response.ok && data.success) {
          if (data.updated) {
            row.querySelector('select[name="status"]').value = data.updated.status;
            row.querySelector('input[name="assigned_to"]').value = data.updated.assigned_to;
          }
          showAlert(statusMessage, data.message, "success");
        } else {
          showAlert(statusMessage, data.error || "Failed to update complaint", "error");
        }
      } catch (err) {
        showAlert(statusMessage, `Error: ${err.message}`, "error");
      }
    }

    // --- Delete Complaint ---
    async function deleteComplaint(button) {
      if (!confirm("Are you sure you want to delete this complaint?")) return;

      const row = button.closest("tr");
      const complaintId = row.dataset.complaintId;

      const payload = { complaint_id: complaintId, modify_key: modifyKey };
      const statusMessage = document.getElementById("status-message");
      showAlert(statusMessage, "Deleting complaint...", "success");

      try {
        const response = await fetch("/delete_complaint", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await response.json();

        if (response.ok && data.success) {
          row.remove();
          showAlert(statusMessage, data.message, "success");
        } else {
          showAlert(statusMessage, data.error || "Failed to delete complaint", "error");
        }
      } catch (err) {
        showAlert(statusMessage, `Error: ${err.message}`, "error");
      }
    }
  </script>
</body>
</html>